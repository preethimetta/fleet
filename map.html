<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LogiQ – Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: Inter, Arial, sans-serif; }
    #map { height: 100%; width: 100%; }

    .eta {
      position: absolute; bottom: 20px; left: 20px; z-index: 1000;
      background: #fff; padding: 12px; border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.2);
      width: 260px;
    }
    .eta p { margin: 6px 0; font-weight: 600; }
    .traffic { color: #ef4444; }
    .classical { color: #10b981; }
    .quantum { color: #7c3aed; }
    .tolls { color: #f59e0b; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="eta">
    <h3>⏱ ETA</h3>
    <p id="eta-traffic" class="traffic">🚦 Traffic: —</p>
    <p id="eta-classical" class="classical">✅ Classical: —</p>
    <p id="eta-quantum" class="quantum">⚛ Quantum: —</p>
    <p id="eta-tolls" class="tolls">💰 Tolls: —</p>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const vehicle = params.get("vehicle");
    const cc = params.get("cc");
    const dest = params.get("dest");

    if (!vehicle || !cc || !dest) {
      alert("Missing parameters from fleet.html");
      throw new Error("Missing parameters");
    }

    const map = L.map('map').setView([20, 78], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    let start = null;
    let destMarker = null;
    let routeLayers = [];
    let tollMarkers = [];

    const tollIcon = L.icon({
      iconUrl: "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -28]
    });

    async function reverseGeocode(lat, lng) {
      try {
        const res = await fetch(`https://logiq-3.onrender.com /reverse_geocode?lat=${lat}&lng=${lng}`);
        const data = await res.json();
        return data.name || "Unknown place";
      } catch {
        return "Unknown place";
      }
    }

    function clearETAs() {
      document.getElementById('eta-traffic').textContent = "🚦 Traffic: —";
      document.getElementById('eta-classical').textContent = "✅ Classical: —";
      document.getElementById('eta-quantum').textContent = "⚛ Quantum: —";
      document.getElementById('eta-tolls').textContent = "💰 Tolls: —";
    }

    function removeRoutes() {
      routeLayers.forEach(l => map.removeLayer(l));
      routeLayers = [];
      tollMarkers.forEach(m => map.removeLayer(m));
      tollMarkers = [];
    }

    function drawRoute(coords, color) {
      const weight = (color === "#7c3aed") ? 8 : 5;
      const poly = L.polyline(coords, { color, weight, opacity: 0.9 }).addTo(map);
      routeLayers.push(poly);
    }

    async function computeRoutes(end) {
      clearETAs(); removeRoutes();
      try {
        const res = await fetch("https://logiq-3.onrender.com/routes", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ start, end, vehicle, cc })
        });
        const data = await res.json();

        if (data.traffic) {
          drawRoute(data.traffic.polyline, "#ef4444");
          document.getElementById('eta-traffic').textContent = `🚦 Traffic: ${data.traffic.eta}`;
        }
        if (data.classical) {
          drawRoute(data.classical.polyline, "#10b981");
          document.getElementById('eta-classical').textContent = `✅ Classical: ${data.classical.eta}`;
        }
        if (data.quantum) {
          drawRoute(data.quantum.polyline, "#7c3aed");
          document.getElementById('eta-quantum').textContent = `⚛ Quantum: ${data.quantum.eta}`;
        }

        if (data.tolls) {
          data.tolls.forEach(t => {
            const marker = L.marker([t.lat, t.lng], { icon: tollIcon })
              .addTo(map).bindPopup(`💰 Toll at: ${t.place || "Unknown Toll Location"}`);
            tollMarkers.push(marker);
          });
          const total = data.tolls.reduce((a,b)=>a+b.cost,0);
          document.getElementById("eta-tolls").textContent = `💰 Tolls: ${data.tolls.length} | ₹${total}`;
        }
      } catch (err) {
        console.error("Route computation failed:", err);
      }
    }

    async function geocodeAndCompute() {
      try {
        const geoRes = await fetch(`https://logiq-3.onrender.com/geocode?query=${encodeURIComponent(dest)}`);
        const geoData = await geoRes.json();
        const lat = geoData.lat || 17.6868;
        const lng = geoData.lng || 83.2185;
        const end = L.latLng(lat, lng);

        const place = await reverseGeocode(end.lat, end.lng);
        if (destMarker) map.removeLayer(destMarker);
        destMarker = L.marker(end).addTo(map).bindPopup(`🎯 Destination: ${place}`).openPopup();

        computeRoutes(end);
      } catch {
        alert("Destination not found. Using Vizag as default.");
        const end = L.latLng(17.6868, 83.2185);
        if (destMarker) map.removeLayer(destMarker);
        destMarker = L.marker(end).addTo(map).bindPopup("🎯 Default Destination: Vizag").openPopup();
        computeRoutes(end);
      }
    }

    // Try geolocation first, fallback to default
    async function initStart() {
      if (!navigator.geolocation) {
        alert("Geolocation not supported. Using default start.");
        start = L.latLng(17.6868, 83.2185);
        const place = await reverseGeocode(start.lat, start.lng);
        L.marker(start).addTo(map).bindPopup(`📍 Start: ${place}`).openPopup();
        geocodeAndCompute();
        return;
      }

      navigator.geolocation.getCurrentPosition(async pos => {
        start = L.latLng(pos.coords.latitude, pos.coords.longitude);
        const place = await reverseGeocode(start.lat, start.lng);
        L.marker(start).addTo(map).bindPopup(`🚚 You are at: ${place}`).openPopup();
        geocodeAndCompute();
      }, async () => {
        alert("Could not get your location. Using default start (Vizag).");
        start = L.latLng(17.6868, 83.2185);
        const place = await reverseGeocode(start.lat, start.lng);
        L.marker(start).addTo(map).bindPopup(`📍 Start: ${place}`).openPopup();
        geocodeAndCompute();
      }, { enableHighAccuracy: true, timeout: 5000 });
    }

    initStart();
  </script>
</body>
</html>
